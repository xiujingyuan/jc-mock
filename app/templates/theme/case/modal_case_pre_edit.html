
<div class="modal fade" id="case_preEdit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 960px;" >
        <div class="modal-content">
            <div class="modal-body">
                <ul class="case-add-modal-title nav nav-tabs" id="myTabPreEdit">
                    <li class="active"><a href="#tab_pre_edit_case_info" data-toggle="tab">用例相关信息</a></li>
                    <li><a href="#tab_pre_edit_info" data-toggle="tab">前置基础信息</a></li>
                    <li><a href="#tab_pre_edit_action" data-toggle="tab">前置处理动作</a></li>
                    <li><a href="#tab_pre_edit_expect" data-toggle="tab">预期值相关</a></li>
                </ul>
                <div class="tab-content tab-modal-content">
                    <div class="tab-pane active" id="tab_pre_edit_case_info">
                        <!--case相关信息开始-->
                        <div style="margin-top: 10px;margin-bottom: 10px;">
                            <div class="panel panel-default">
                                <div class="panel-heading">case相关信息</div>
                                <div class="panel-body">
                                    <div id="" class="form-horizontal">
                                        <div class="form-group" style="margin-top: 15px;">
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_case_name">用例编号</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class=" form-control" readonly id="readonly_pre_edit_case_id">
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_case_description">用例描述</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" readonly id="readonly_pre_edit_case_description">
                                                    <input type="text" readonly id="readonly_pre_edit_prev_id" hidden>
                                                    <input type="text" readonly id="readonly_pre_edit_prev_index" hidden>
                                                    <input type="text" readonly id="readonly_pre_edit_case_action" hidden>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--case相关信息结束-->
                    </div>
                    <div class="tab-pane" id="tab_pre_edit_info">
                        <!--前置基础信息开始-->
                        <div style="margin-top: 10px;margin-bottom: 10px;">
                            <div class="panel panel-default">
                                <div class="panel-heading">前置基础信息</div>
                                <div class="panel-body">
                                    <div id="" class="form-horizontal">
                                        <div class="form-group" style="margin-top: 15px;">
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_edit_pre_name">前置名称</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="txt_edit_pre_name" maxlength="500">
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_pre_description">前置描述</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="txt_edit_pre_description" maxlength="500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="" class="form-horizontal">
                                        <div class="form-group" style="margin-top: 15px;">
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_edit_pre_type">
                                                    <label data-toggle="tooltip" data-html="true" data-placement="bottom" title="
                                                        <p align='left'>
                                                            <li>common：当为common时是通过prev_case_id 关联的。</li>
                                                            <li>msg： 通过case_next_msg 关联，公共的msg prev_case_id= -1</li>
                                                            <li>task：通过case_next_task 关联  公共的task prev_case_id =0</li>
                                                            <li>当task 或者msg 的prev_case_id 为case_id 会忽略公共的task或者msg</li>
                                                            </p>
                                                        " class="glyphicon glyphicon-question-sign"></label>
                                                    前置类型</label>
                                                <div class="col-sm-8">
                                                    <select id="sel_edit_pre_type" name="country" class="form-control selectpicker " data-style="btn-primary" style="height: 55px;">
                                                        <option>common</option>
                                                        <option>task</option>
                                                        <option>msg</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_edit_prev_flag">
                                                    <label data-toggle="tooltip" data-html="true" data-placement="bottom" title="
                                                        <p align='left'>
                                                            用于处理前置的事物，大部分情况下前置标志已经写好。
                                                            如果需要新增一个没有的前置标志且前置类型为common
                                                            需要新增一个前置标志名称的方法来处理。
                                                            现在正在使用的前置标志如下：eg ：
                                                            <li>four_important_element ： grant 系统处理进件</li>
                                                            <li>prev_actual_value：处理实际值，所以setuptype = teardown</li>
                                                            <li>prev_except_value：处理预期值</li>
                                                            <li>prev_except_response_value ：处理预期值</li>
                                                            <li>extend_mainresponse_torequestbody：从全局变量中获取值填充到请求参数中
                                                            （case_api_params或者case_sql_params）根据case_check_method来确定</li>
                                                            <li>prev_sync_withdrawsuccess ：还款使用</li>
                                                            <li>prev_get_withhold_amount：还款使用</li>

                                                            </p>
                                                        " class="glyphicon glyphicon-question-sign"></label>
                                                    前置标志</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="txt_edit_prev_flag" maxlength="100">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin-top: 15px;">
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_prev_priority">
                                                    执行优先级</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="txt_edit_prev_priority" maxlength="100">
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_prev_wait_time">
                                                    等待时间</label>
                                                <div class="col-sm-8">
                                                    <input type="text" class="form-control" id="txt_edit_prev_wait_time" maxlength="100">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="" class="form-horizontal">
                                        <div class="form-group" style="margin-top: 15px;">
                                            <div class="col-sm-6">
                                                <label class="control-label col-sm-4" for="txt_edit_pre_type">执行类型</label>
                                                <div class="col-sm-8">
                                                    <select id="sel_edit_pre_setup_type" name="country" class="form-control selectpicker " data-style="btn-primary" style="height: 55px;">
                                                        <option>setup</option>
                                                        <option>teardown</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--前置基础信息结束-->
                    </div>
                    <div class="tab-pane" id="tab_pre_edit_action">
                        <!--前置处理动作开始-->
                        <div style="margin-top: 10px;margin-bottom: 10px;">
                            <div class="panel panel-default">
                                <div class="panel-heading">前置处理动作</div>
                                <div class="panel-body">
                                    <ul id="myPre" class="case-add-modal-title nav nav-tabs">
                                        <li class="active">
                                            <a href="#edit_pre0" data-toggle="tab">http请求</a>
                                        </li>
                                        <li>
                                            <a href="#edit_pre1" data-toggle="tab">数据库请求</a>
                                        </li>
                                        <li>
                                            <a href="#edit_pre2" data-toggle="tab">公共相关</a>
                                        </li>
                                    </ul>
                                    <div id="myPreContent" class="tab-modal-content">
                                        <div style="margin-top: 10px;margin-bottom: 10px;"></div>
                                        <div class="tab-pane fade in active" id="edit_pre0">
                                            <div>
                                                <form id="formSearch" class="form-horizontal">
                                                    <div class="form-group" style="margin-top:15px">
                                                        <label class="control-label col-sm-1" style="width: 120px;" for="txt_pre_request_url">请求URL</label>
                                                        <div class="col-sm-10">
                                                            <input type="text" class="form-control" id="txt_edit_pre_request_url" maxlength="500">
                                                        </div>
                                                    </div>
                                                    <div class="form-group" style="margin-top:15px">
                                                        <label class="control-label col-sm-1" style="width: 120px;" for="txt_edit_pre_request_method">请求方式</label>
                                                        <div class="col-sm-4">
                                                            <select id="sel_edit_pre_request_method" name="country" class="form-control selectpicker " data-style="btn-primary" style="height: 55px;">
                                                                <option>POST</option>
                                                                <option>GET</option>
                                                                <option>DELETE</option>
                                                                <option>PUT</option>
                                                            </select>
                                                        </div>
                                                        <label class="control-label col-sm-1" style="width: 150px;" for="txt_edit_pre_request_header">请求头信息</label>
                                                        <div class="col-sm-4">
                                                            <select id="sel_edit_pre_request_header" name="country" class="form-control selectpicker " data-style="btn-primary" style="height: 55px;">
                                                                <option>application/json</option>
                                                                <option>application/x-www-form-urlencoded</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="form-group" style="margin-top:15px">
                                                        <label class="control-label col-sm-1" style="width: 120px;margin-top: 30px;" for="txt_edit_pre_request_args">请求参数</label>
                                                        <div class="col-sm-10">
                                                            <div id="json_edit_pre_request_args"></div>
                                                        </div>
                                                    </div>
                                                </form>
                                                <form id="formSearch" class="form-horizontal">
                                                    <div class="form-group" style="margin-top:15px;display: none;">
                                                        <label class="control-label col-sm-1" style="width: 120px;margin-top: 30px;" for="txt_edit_pre_replace">替换表达式</label>
                                                        <div class="col-sm-10">
                                                            <div id="json_edit_pre_http_replace"></div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="edit_pre1">
                                            <form id="formSearch" class="form-horizontal">
                                                <div class="form-group" style="margin-top:15px">
                                                    <label class="control-label col-sm-1"  style="width: 120px;"for="txt_edit_pre_sql">sql语句</label>
                                                    <div class="col-sm-10">
                                                        <textarea id="txt_edit_pre_sql" rows="5" class="form-control"></textarea>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="margin-top:15px">
                                                    <label class="control-label col-sm-1"  style="width: 120px;"for="txt_edit_pre_sql_args">sql参数</label>
                                                    <div class="col-sm-10">
                                                        <div id="json_edit_pre_sql_args"></div>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="margin-top:15px;">
                                                    <label class="control-label col-sm-1" style="width: 120px;display: none;" for="txt_edit_pre_sql_replace">替换表达式</label>
                                                    <div class="col-sm-5" style="display: none;">
                                                        <div id="json_edit_pre_sql_replace"></div>
                                                    </div>

                                                    <label class="control-label col-sm-1" style="width: 120px;" for="txt_edit_pre_run_sql_device">执行数据库</label>

                                                    <div class="col-sm-3">
                                                        <input type="text" class="form-control" id="sel_edit_pre_run_sql_device" maxlength="500">
                                                    </div>

                                                </div>
                                            </form>
                                        </div>
                                        <div class="tab-pane fade" id="edit_pre2">
                                            <form id="formSearch" class="form-horizontal">
                                                <div class="form-group" style="margin-top:15px;">
                                                    <label class="control-label col-sm-2"  style="width: 180px;"for="txt_edit_public_replace">公共替换表达式</label>
                                                    <div class="col-sm-9">
                                                        <div id="json_edit_public_replace"></div>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="margin-top:15px">
                                                    <label class="control-label col-sm-2"  style="width: 180px;"for="txt_edit_user_args">用户变量定义参数</label>
                                                    <div class="col-sm-9">
                                                        <div id="json_edit_pre_user_args"></div>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="margin-top:15px;display: none;">
                                                    <label class="control-label col-sm-2" style="width: 180px;" for="txt_edit_pre_replace">预期值替换表达式</label>
                                                    <div class="col-sm-9">
                                                        <div id="json_edit_pre_replace"></div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--前置处理动作结束-->
                    </div>
                    <div class="tab-pane" id="tab_pre_edit_expect">
                       <!--预期值相关开始-->
                        <div style="margin-top: 10px;">
                            <div class="panel panel-default">
                                <div class="panel-heading">预期值相关</div>
                                <div class="panel-body">
                                    <div id="" class="form-horizontal">
                                        <div class="form-group" >
                                            <label class="control-label col-sm-1" style="width: 120px;margin-top: 30px;" for="txt_pre_expect">用例预期值</label>
                                            <div class="col-sm-10">
                                                <div id="json_edit_pre_expect"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--预期值相关结束-->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="pre_edit_btn_cancel">取消</button>
                <button type="button" class="btn btn-default" id="pre_edit_btn_save">保存</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<script>



    $("#pre_edit_btn_save").click(function () {
        var action = $("#readonly_pre_edit_case_action").val();
        var prev_name = $("#txt_edit_pre_name").val();
        var prev_description = $("#txt_edit_pre_description").val();
        var prev_task_type = $("#sel_edit_pre_type").val();
        var prev_flag = $("#txt_edit_prev_flag").val();
        var prev_setup_type = $("#sel_edit_pre_setup_type").val();
        var prev_case_id = $("#readonly_pre_edit_case_id").val();
        var prev_priority = $("#txt_edit_prev_priority").val()
        var prev_wait_time = $("#txt_edit_prev_wait_time").val()
        var prev_except_value = get_reverse_json_value(json_dict['json_edit_pre_expect'].get());
        var prev_id = $("#readonly_pre_edit_prev_id").val();
        var prev_api_address =$("#txt_edit_pre_request_url").val();
        var prev_api_method =$("#sel_edit_pre_request_method").val();
        var prev_api_header =$("#sel_edit_pre_request_header").val();
        var prev_api_header_dict = JSON.stringify({
            "Content-type":prev_api_header
        });
        var index = $("#readonly_pre_edit_prev_index").val();

        var prev_api_params = get_reverse_json_value(json_dict['json_edit_pre_request_args'].get());
        var prev_api_expression = get_reverse_json_value(json_dict['json_edit_pre_http_replace'].get());
        var prev_sql_statement = $("#txt_edit_pre_sql").val();
        var prev_sql_database = $("#sel_edit_pre_run_sql_device").val();
        var prev_sql_params = get_reverse_json_value(json_dict['json_edit_pre_sql_args'].get());
        var prev_sql_expression = get_reverse_json_value(json_dict['json_edit_pre_sql_replace'].get());

        var prev_expression = get_reverse_json_value(json_dict['json_edit_public_replace'].get());
        var prev_params = get_reverse_json_value(json_dict['json_edit_pre_user_args'].get());
        var prev_except_expression = get_reverse_json_value(json_dict['json_edit_pre_replace'].get());
        var prev_in_user ="";
        var prev_except_value = get_reverse_json_value(json_dict['json_edit_pre_expect'].get());

        if(prev_name==""){
            toastr.warning("warning", '前置名称不能为空');
            return
        }
        if(prev_flag==""){
            toastr.warning("warning", '前置名称标志不能为空');
            return
        }
        if(prev_api_address==""){
            prev_api_header_dict=""
            prev_api_method=""
        }
        if(prev_sql_statement==""){
            prev_sql_database=""
        }
        if (action!="update"){
            prev_in_user="{{ current_user.username }}"
        }

        edit_data ={
            "prev_id": prev_id,
            "prev_name": prev_name,
            "prev_case_id":prev_case_id,
            "prev_description": prev_description,
            "prev_flag": prev_flag,
            "prev_task_type": prev_task_type,
            "prev_setup_type": prev_setup_type,
            "prev_api_address": prev_api_address,
            "prev_api_method": prev_api_method,
            "prev_api_params":prev_api_params,
            "prev_api_header": prev_api_header_dict,
            "prev_api_expression": prev_api_expression,
            "prev_sql_statement": prev_sql_statement,
            "prev_sql_params": prev_sql_params,
            "prev_sql_database": prev_sql_database,
            "prev_sql_expression": prev_sql_expression,
            "prev_expression": prev_expression,
            "prev_params": prev_params,
            "prev_except_expression": prev_except_expression,
            "prev_except_value": prev_except_value,
            "prev_priority":prev_priority,
            "prev_wait_time":prev_wait_time,
            "prev_in_user":prev_in_user,
            "prev_last_user": "{{ current_user.username }}",
            "prev_in_date": get_date(),
            "prev_last_date": get_date()
        };


        var edit_data_temp = JSON.stringify(edit_data);
        if(action=="update") {

            $.ajax({
                url: "/api/case/prev/update/",
                contentType: "application/json; charset=UTF-8",
                headers: {"X-CSRFToken": "{{ csrf_token() }}"},
                async: true,
                type: "PUT",
                data: edit_data_temp,
                // 成功后开启模态框
                success: function (data) {
                    if (data["code"] == 1) {
                        toastr.warning("warning", "修改前置处理失败");
                    }

                    else {
                        toastr.success("success", "修改前置处理成功");

                        $("#tb_edit_pre").bootstrapTable('updateRow', {
                            index: index,
                            row: edit_data
                        });
                    }
                },
                error: function () {
                    $("#update_warning").text("网络异常，请求失败");
                    $("#update_warning").show()
                },
                dataType: "json"
            });
        }else{

            $.ajax({
                url: "/api/case/prev/add",
                contentType: "application/json; charset=UTF-8",
                headers: {"X-CSRFToken": "{{ csrf_token() }}"},
                async: true,
                type: "POST",
                data: edit_data_temp,
                // 成功后开启模态框
                success: function (data) {
                    if (data["code"] == 1) {
                        toastr.warning("warning", "添加前置处理失败");
                    }

                    else {
                        toastr.success("success", "添加前置处理成功");

                        $("#tb_edit_pre").bootstrapTable('insertRow', {
                            index: 0,
                            row: data.origin_data
                        });
                    }
                },
                error: function () {
                    $("#update_warning").text("网络异常，请求失败");
                    $("#update_warning").show()
                },
                dataType: "json"
            });
        }

        $("#pre_edit_btn_cancel").click();

    });

    function bind_prev_edit_addprev(case_id,action,name) {
        $("#readonly_pre_edit_case_id").val(case_id);
        $("#readonly_pre_edit_case_action").val(action);
        $("#readonly_pre_edit_case_description").val(name);
        $("#txt_edit_pre_name").val("");
        $("#txt_edit_pre_description").val("");
        $("#sel_edit_pre_type").selectpicker('val','common');
        $("#txt_edit_prev_flag").val("");
        $("#sel_edit_pre_setup_type").selectpicker('val','setup');
        $("#txt_edit_pre_request_url").val("");
        $("#sel_edit_pre_request_method").selectpicker('val',"POST");
        $("#sel_edit_pre_request_header").selectpicker('val','application/json');
        $("#txt_edit_prev_priority").val("");
        json_dict['json_edit_pre_request_args'].set({});
        json_dict['json_edit_pre_http_replace'].set({});
        json_dict['json_edit_pre_sql_args'].set({});
        json_dict['json_edit_pre_sql_replace'].set({});
        json_dict['json_edit_pre_user_args'].set({});
        json_dict['json_edit_pre_replace'].set({});
        json_dict['json_edit_pre_expect'].set({});
        json_dict['json_edit_public_replace'].set({});
        $("#txt_edit_pre_sql").val();
        $("#sel_edit_pre_run_sql_device").val();
        $("#readonly_pre_edit_prev_id").val();
    }

    function bind_pre_data(data,index,action,name) {

        $("#readonly_pre_edit_case_action").val(action);
        $("#readonly_pre_edit_case_id").val(data['prev_case_id']);
        $("#readonly_pre_edit_case_description").val(name);
        $("#txt_edit_pre_name").val(data['prev_name']);
        $("#txt_edit_pre_description").val(data['prev_description']);
        $("#sel_edit_pre_type").selectpicker('val',data['prev_task_type']);
        $("#txt_edit_prev_flag").val(data['prev_flag']);
        $("#sel_edit_pre_setup_type").selectpicker('val',data['prev_setup_type']);
        $("#txt_edit_pre_request_url").val(data['prev_api_address']);
        $("#sel_edit_pre_request_method").selectpicker('val',data['prev_api_method']);
        $("#txt_edit_prev_priority").val(data['prev_priority']);
        $("#txt_edit_prev_wait_time").val(data['prev_wait_time']);
        var header =  data['prev_api_header']
        var temp_header="application/json"
        //header = change_value_mark(header)
        if($.isEmptyObject(header)==false){
            if(header.hasOwnProperty("Content-type")){

                temp_header = header['Content-type'];
            }else if (header.hasOwnProperty("Content-Type")){
                temp_header = header['Content-Type'];
            }else if(header.hasOwnProperty("content-type")){
                temp_header = header['content-type'];
            }else if(header.hasOwnProperty("content-Type")){
                temp_header = header['content-Type'];
            }
        }


        $("#sel_edit_pre_request_header").selectpicker('val',temp_header);
        json_dict['json_edit_pre_request_args'].set(get_json_value(data['prev_api_params']));
        json_dict['json_edit_pre_http_replace'].set(get_json_value(data['prev_api_expression']));
        json_dict['json_edit_pre_sql_args'].set(get_json_value(data['prev_sql_params']));
        json_dict['json_edit_pre_sql_replace'].set(get_json_value(data['prev_sql_expression']));
        json_dict['json_edit_pre_user_args'].set(get_json_value(data['prev_params']));
        json_dict['json_edit_pre_replace'].set(get_json_value(data['prev_except_expression']));
        json_dict['json_edit_pre_expect'].set(get_json_value(data['prev_except_value']));
        json_dict['json_edit_public_replace'].set(get_json_value(data['prev_expression']));

        $("#txt_edit_pre_sql").val(data['prev_sql_statement']);
        $("#sel_edit_pre_run_sql_device").val(data['prev_sql_database']);
        $("#readonly_pre_edit_prev_id").val(data['prev_id'])
        $("#readonly_pre_edit_prev_index").val(index)

    }

    function get_json_value(data){
        if($.isEmptyObject(data)){
            return {}
        }else{
            return data
        }
    }

    function get_reverse_json_value(data) {
        if($.isEmptyObject(data)){
            return "";
        }else{
            return JSON.stringify(data);
        }
    }

</script>

